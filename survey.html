<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Root — Values Survey</title>

  <!-- ✅ Shared sitewide stylesheet -->
  <link rel="stylesheet" href="./styles.css?v=4" />

  <!-- Plotly library -->
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

  <link rel="icon" href="favicon.ico" />
</head>
<body>
  <!-- Top nav -->
  <p class="topnav"><a href="index.html">← Back to Home</a></p>

  <!-- HERO -->
  <div class="hero">
    <h1>Place your two points</h1>
    <p class="lead">
      One dot for <em>today</em>, one dot for <em>2075</em>. Each dot shows the balance between
      <strong>Autonomy</strong>, <strong>Knowledge Integrity</strong>, and <strong>Equality</strong>.
    </p>
    <div class="badges">
      <span class="badge">Autonomy</span>
      <span class="badge">Knowledge Integrity</span>
      <span class="badge">Equality</span>
    </div>
  </div>

  <!-- PLOTS + CONTROLS -->
  <section class="card">
    <div id="ver" class="lead" style="text-align:center;">Checking Plotly…</div>

    <div class="grid">
      <!-- TODAY -->
      <div class="card">
        <h2 style="margin-top:0">Today</h2>
        <div id="plot-today" style="height:520px;"></div>
        <div class="controls">
          <label>A (%): <input type="number" id="todayA" min="0" max="100" value="34"></label>
          <label>B (%): <input type="number" id="todayB" min="0" max="100" value="33"></label>
          <label>C (%): <input type="number" id="todayC" min="0" max="100" value="33"></label>
          <a class="btn ghost" href="#" id="btnSetToday">Set point</a>
        </div>
      </div>

      <!-- 2075 -->
      <div class="card">
        <h2 style="margin-top:0">Year 2075</h2>
        <div id="plot-2075" style="height:520px;"></div>
        <div class="controls">
          <label>A (%): <input type="number" id="y2075A" min="0" max="100" value="34"></label>
          <label>B (%): <input type="number" id="y2075B" min="0" max="100" value="33"></label>
          <label>C (%): <input type="number" id="y2075C" min="0" max="100" value="33"></label>
          <a class="btn ghost" href="#" id="btnSetFuture">Set point</a>
        </div>
      </div>
    </div>

    <div style="display:flex; align-items:center; gap:14px; margin-top:14px; flex-wrap:wrap">
      <a class="btn" href="#" id="submit-btn" style="opacity:.6; pointer-events:none">Submit response →</a>
      <span id="status" class="status"></span>
    </div>
  </section>

  <footer>
    <p>© 2025 UCD Digital Society — Root Survey</p>
  </footer>

  <script>
    // ====== Google Sheets endpoint (Apps Script Web App URL) ======
    const ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbwpSjXu7XWv1h1eQb94VsDSlHoE53lG252Z6suitVW0bGZYp8PPhyHCUujlxzeg1vwj9g/exec";
    // =============================================================

    // Labels
    const LABELS = {
      A: "Individual Autonomy",
      B: "Knowledge Integrity",
      C: "Equal Opportunity"
    };

    // Plotly version hint
    try {
      document.getElementById('ver').textContent = 'Plotly loaded: v' + (window.Plotly?.version || 'NOT LOADED');
      console.log('Plotly version:', window.Plotly?.version);
    } catch (e) {}

    // UUID per browser to discourage duplicates
    function getUUID() {
      const key = 'values_survey_uuid';
      let u = localStorage.getItem(key);
      if (!u) {
        u = ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
          (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
        );
        localStorage.setItem(key, u);
      }
      return u;
    }

    // Dense click grid so taps always hit a point
    function generateGrid(step = 0.04) {
      const a = [], b = [], c = [];
      for (let i = 0; i <= 1/step; i++) {
        const ai = +(i * step).toFixed(6);
        for (let j = 0; j <= (1 - ai) / step; j++) {
          const bj = +(j * step).toFixed(6);
          const ck = +(1 - ai - bj).toFixed(6);
          if (ck >= -1e-9) { a.push(ai); b.push(bj); c.push(ck); }
        }
      }
      return { a, b, c };
    }

    function makeFigure() {
      const grid = generateGrid(0.04);
      return {
        data: [
          {
            type: "scatterternary",
            mode: "markers",
            a: grid.a, b: grid.b, c: grid.c,
            marker: { size: 16, opacity: 0.005 },
            hoverinfo: "skip",
            name: "click-grid"
          },
          {
            type: "scatterternary",
            mode: "markers",
            a: [], b: [], c: [],
            marker: { size: 12 },
            name: "response"
          }
        ],
        layout: {
          ternary: {
            aaxis: { title: LABELS.A, min: 0 },
            baxis: { title: LABELS.B, min: 0 },
            caxis: { title: LABELS.C, min: 0 },
            sum: 1
          },
          dragmode: "pan",
          clickmode: "event+select",
          hovermode: "closest",
          margin: { l: 40, r: 40, b: 40, t: 20 }
        },
        config: { responsive: true, displayModeBar: false }
      };
    }

    const state = { today: null, y2075: null };

    function updateSubmitState() {
      const ready = (state.today && state.y2075);
      const btn = document.getElementById('submit-btn');
      btn.style.pointerEvents = ready ? 'auto' : 'none';
      btn.style.opacity = ready ? '1' : '.6';
    }

    function mountPlot(containerId, key) {
      const el = document.getElementById(containerId);
      const fig = makeFigure();
      Plotly.newPlot(el, fig.data, fig.layout, fig.config).then(() => {
        el.on('plotly_click', (ev) => {
          const pt = ev.points?.[0];
          if (!pt || pt.a == null || pt.b == null || pt.c == null) return;
          const a = pt.a, b = pt.b, c = pt.c;
          Plotly.restyle(el, { a: [[a]], b: [[b]], c: [[c]] }, [1]); // update response trace
          state[key] = { a, b, c };
          updateSubmitState();
        });
      }).catch(err => {
        console.error('Plot init failed for', containerId, err);
        alert('Plot failed to load — check console for details.');
      });
    }

    function setPointFromInputs(which) {
      const ids = which === 'today' ? ['todayA','todayB','todayC'] : ['y2075A','y2075B','y2075C'];
      const vals = ids.map(id => Math.max(0, Math.min(100, +document.getElementById(id).value || 0)));
      const sum = vals[0] + vals[1] + vals[2];
      if (!sum) return;
      const a = vals[0]/sum, b = vals[1]/sum, c = vals[2]/sum;
      const el = document.getElementById(which === 'today' ? 'plot-today' : 'plot-2075');
      Plotly.restyle(el, { a: [[a]], b: [[b]], c: [[c]] }, [1]);
      state[which] = { a, b, c };
      updateSubmitState();
    }

    // Mount plots
    if (!window.Plotly) {
      alert('Plotly did not load. Check your network or the CDN URL.');
    } else {
      mountPlot('plot-today', 'today');
      mountPlot('plot-2075', 'y2075');
    }

    // Button handlers
    document.getElementById('btnSetToday').addEventListener('click', (e)=>{ e.preventDefault(); setPointFromInputs('today'); });
    document.getElementById('btnSetFuture').addEventListener('click', (e)=>{ e.preventDefault(); setPointFromInputs('y2075'); });

    // Submit → Apps Script → redirect to thank-you
    document.getElementById('submit-btn').addEventListener('click', async (e) => {
      e.preventDefault();
      const status = document.getElementById('status');
      if (!state.today || !state.y2075) return;

      const payload = {
        labels: LABELS,
        today: state.today,
        y2075: state.y2075,
        ts: new Date().toISOString(),
        uuid: getUUID(),
        ua: navigator.userAgent
      };

      status.textContent = 'Submitting…';

      try {
        const body = new URLSearchParams({ payload: JSON.stringify(payload) });
        await fetch(ENDPOINT_URL, { method: 'POST', body });
        status.textContent = 'Thanks — response recorded! Redirecting…';
        setTimeout(() => { window.location.href = 'thankyou.html'; }, 700);
      } catch (e) {
        console.error(e);
        status.textContent = 'Error submitting — please try again.';
      }
    });
  </script>
</body>
</html>
